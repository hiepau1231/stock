{% extends "layouts/base.html" %}

{% load crispy_forms_tags %}

{% load currency_filters %}

{% load stock_filters %}

{% load humanize %}



{% block title %} Dashboard {% endblock %}



{% block stylesheets %}

{{ block.super }}

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<style>

    .index-card {

        transition: all 0.3s;

    }

    .index-card:hover {

        transform: translateY(-5px);

        box-shadow: 0 4px 8px rgba(0,0,0,0.1);

    }

    .loading {

        display: none;

        position: fixed;

        z-index: 999;

        height: 2em;

        width: 2em;

        overflow: show;

        margin: auto;

        top: 0;

        left: 0;

        bottom: 0;

        right: 0;

    }

    .loading:before {

        content: '';

        display: block;

        position: fixed;

        top: 0;

        left: 0;

        width: 100%;

        height: 100%;

        background-color: rgba(0,0,0,0.3);

    }

    .loading:not(:required) {

        font: 0/0 a;

        color: transparent;

        text-shadow: none;

        background-color: transparent;

        border: 0;

    }

    .loading:not(:required):after {

        content: '';

        display: block;

        font-size: 10px;

        width: 1em;

        height: 1em;

        margin-top: -0.5em;

        animation: spinner 1500ms infinite linear;

        border-radius: 0.5em;

        box-shadow: rgba(0, 0, 0, 0.75) 1.5em 0 0 0, rgba(0, 0, 0, 0.75) 1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) 0 1.5em 0 0, rgba(0, 0, 0, 0.75) -1.1em 1.1em 0 0, rgba(0, 0, 0, 0.75) -1.5em 0 0 0, rgba(0, 0, 0, 0.75) -1.1em -1.1em 0 0, rgba(0, 0, 0, 0.75) 0 -1.5em 0 0, rgba(0, 0, 0, 0.75) 1.1em -1.1em 0 0;

    }

    @keyframes spinner {

        0% { transform: rotate(0deg); }

        100% { transform: rotate(360deg); }

    }

    @media (max-width: 768px) {

        .index-card {

            margin-bottom: 1rem;

        }

        .card-body {

            padding: 1rem;

        }

    }

</style>

{% endblock stylesheets %}



{% block content %}
<div class="container-fluid mt--6">
  {% if has_data %}
    <div class="row">
      {% for index in indices %}
      <div class="col-xl-3 col-md-6">
        <div class="card card-stats index-card">
          <div class="card-body">
            <div class="row">
              <div class="col">
                <h5 class="card-title text-uppercase text-muted mb-0">{{ index.name }}</h5>
                <span class="h2 font-weight-bold mb-0">{{ index.value|floatformat:2 }}</span>
              </div>
              <div class="col-auto">
                <div class="icon icon-shape bg-gradient-primary text-white rounded-circle shadow">
                  <i class="ni ni-chart-bar-32"></i>
                </div>
              </div>
            </div>
            <p class="mt-3 mb-0 text-sm">
              <span class="text-{% if index.change >= 0 %}success{% else %}danger{% endif %} mr-2">
                <i class="fa fa-arrow-{% if index.change >= 0 %}up{% else %}down{% endif %}"></i> {{ index.change|floatformat:2 }}%
              </span>
              <span class="text-nowrap">Cập nhật lúc {{ index.last_updated|date:"H:i:s" }}</span>
            </p>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    
    <!-- Phần hiển thị biểu đồ và dữ liệu khác -->
    
  {% else %}
    <div class="alert alert-warning">
      Chưa có dữ liệu. Vui lòng cập nhật dữ liệu từ chức năng cập nhật.
      {% if error %}
        <br>
        <small class="text-muted">Lỗi: {{ error }}</small>
      {% endif %}
    </div>
  {% endif %}

  <a href="{% url 'stock_analysis:update_stock_data' %}" class="btn btn-info mt-3">
    <i class="fas fa-sync-alt"></i> Cập nhật dữ liệu
  </a>
</div>

<div class="loading">Loading&#8230;</div>

{% if messages %}

<div class="messages position-fixed bottom-0 right-0 p-3" style="z-index: 1050">

    {% for message in messages %}

    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">

        <i class="fas fa-{% if message.tags == 'success' %}check-circle{% else %}exclamation-circle{% endif %} mr-2"></i>

        {{ message }}

        <button type="button" class="close" data-dismiss="alert" aria-label="Close">

            <span aria-hidden="true">&times;</span>

        </button>

    </div>

    {% endfor %}

</div>

{% endif %}

{% endblock content %}



{% block javascripts %}

{{ block.super }}

<script>

$(document).ready(function() {

    $('#updateForm').on('submit', function() {

        $('.loading').show();

    });

    

    $(window).on('resize', function() {

        Plotly.Plots.resize('plotDiv');

    });

});

</script>

{% endblock javascripts %}



